name: contrib
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write # to update _contrib

jobs:
  update-contrib:
    name: Update _contrib
    runs-on: ubuntu-latest

    steps:
      - name: Checkout website
        uses: actions/checkout@v3

      - name: Checkout hyper
        uses: actions/checkout@v3
        with:
          repository: hyperium/hyper
          path: hyper

      - name: Convert doc titles to frontmatter 
        run: |
          for f in hyper/docs/*.md; do
            sed -i -e '1i ---' \
            -e '1s/#/title:/'\
            -e '2i layout: guide' \
            -e '2i ---' $f;
          done

      - name: Convert readme to index
        run: |
          sed -i -e '4i permalink: /contrib/' hyper/docs/README.md
          mv hyper/docs/README.md hyper/docs/index.md

      # TODO: fix markdown links

      - name: Lowercase filenames and replace underscores
        run: |
          for f in hyper/docs/*; do
            mv -vn "$f" "$(echo "$f" | tr '[:upper:]' '[:lower:]' | tr '_' '-')"; 
          done

      - name: Copy docs to contrib
        run: |  
          mkdir -p _contrib
          cp -a hyper/docs/. _contrib/

      - name: Push contrib changes to website
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add _contrib/
          git diff --staged --quiet || git commit -m "actions: update contrib"
          git push
